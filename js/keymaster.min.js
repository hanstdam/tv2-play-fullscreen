//     keymaster.js
//     (c) 2011-2013 Thomas Fuchs
//     keymaster.js may be freely distributed under the MIT license.

(function(e){function f(e,t){var n=e.length;while(n--)if(e[n]===t)return n;return-1}function l(e,t){if(e.length!=t.length)return false;for(var n=0;n<e.length;n++){if(e[n]!==t[n])return false}return true}function h(e){for(t in r)r[t]=e[c[t]]}function p(e){var t,i,o,u,l,c;t=e.keyCode;if(f(a,t)==-1){a.push(t)}if(t==93||t==224)t=91;if(t in r){r[t]=true;for(o in s)if(s[o]==t)m[o]=true;return}h(e);if(!m.filter.call(this,e))return;if(!(t in n))return;c=S();for(u=0;u<n[t].length;u++){i=n[t][u];if(i.scope==c||i.scope=="all"){l=i.mods.length>0;for(o in r)if(!r[o]&&f(i.mods,+o)>-1||r[o]&&f(i.mods,+o)==-1)l=false;if(i.mods.length==0&&!r[16]&&!r[18]&&!r[17]&&!r[91]||l){if(i.method(e,i)===false){if(e.preventDefault)e.preventDefault();else e.returnValue=false;if(e.stopPropagation)e.stopPropagation();if(e.cancelBubble)e.cancelBubble=true}}}}}function d(e){var t=e.keyCode,n,i=f(a,t);if(i>=0){a.splice(i,1)}if(t==93||t==224)t=91;if(t in r){r[t]=false;for(n in s)if(s[n]==t)m[n]=false}}function v(){for(t in r)r[t]=false;for(t in s)m[t]=false}function m(e,t,r){var i,s;i=T(e);if(r===undefined){r=t;t="all"}for(var o=0;o<i.length;o++){s=[];e=i[o].split("+");if(e.length>1){s=N(e);e=[e[e.length-1]]}e=e[0];e=u(e);if(!(e in n))n[e]=[];n[e].push({shortcut:i[o],scope:t,method:r,key:i[o],mods:s})}}function g(e,t){var r,i,s=[],o,a,f;r=T(e);for(a=0;a<r.length;a++){i=r[a].split("+");if(i.length>1){s=N(i);e=i[i.length-1]}e=u(e);if(t===undefined){t=S()}if(!n[e]){return}for(o=0;o<n[e].length;o++){f=n[e][o];if(f.scope===t&&l(f.mods,s)){n[e][o]={}}}}}function y(e){if(typeof e=="string"){e=u(e)}return f(a,e)!=-1}function b(){return a.slice(0)}function w(e){var t=(e.target||e.srcElement).tagName;return!(t=="INPUT"||t=="SELECT"||t=="TEXTAREA")}function E(e){i=e||"all"}function S(){return i||"all"}function x(e){var t,r,i;for(t in n){r=n[t];for(i=0;i<r.length;){if(r[i].scope===e)r.splice(i,1);else i++}}}function T(e){var t;e=e.replace(/\s/g,"");t=e.split(",");if(t[t.length-1]==""){t[t.length-2]+=","}return t}function N(e){var t=e.slice(0,e.length-1);for(var n=0;n<t.length;n++)t[n]=s[t[n]];return t}function C(e,t,n){if(e.addEventListener)e.addEventListener(t,n,false);else if(e.attachEvent)e.attachEvent("on"+t,function(){n(window.event)})}function L(){var t=e.key;e.key=k;return t}var t,n={},r={16:false,18:false,17:false,91:false},i="all",s={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,command:91},o={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},u=function(e){return o[e]||e.toUpperCase().charCodeAt(0)},a=[];for(t=1;t<20;t++)o["f"+t]=111+t;var c={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey"};for(t in s)m[t]=false;C(document,"keydown",function(e){p(e)});C(document,"keyup",d);C(window,"focus",v);var k=e.key;e.key=m;e.key.setScope=E;e.key.getScope=S;e.key.deleteScope=x;e.key.filter=w;e.key.isPressed=y;e.key.getPressedKeyCodes=b;e.key.noConflict=L;e.key.unbind=g;if(typeof module!=="undefined")module.exports=m})(this)